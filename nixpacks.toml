[phases.setup]
nixPkgs = ['nodejs']
cmds = [
  'export SHELL=/bin/bash',
  'corepack enable',
  'corepack prepare pnpm@8.15.1 --activate',
  'mkdir -p /root/.local/share/pnpm',
  'export PNPM_HOME="/root/.local/share/pnpm"',
  'export PATH="$PNPM_HOME:$PATH"',
  'npm install -g prisma@5.22.0'
]

[phases.install]
cmds = [
  'pnpm install --no-frozen-lockfile',
  'cd packages/database && npx prisma generate && cd ../..',
  'cd apps/api && npx prisma generate && cd ../..',
  'pnpm install --no-frozen-lockfile'
]

[phases.build]
cmds = [
  'cd packages/database && pnpm build && cd ../..',
  'cd apps/api && pnpm build'
]

[start]
cmd = 'cd apps/api && NODE_ENV=production pnpm start:prod'

[variables]
NODE_ENV = 'production'
NPM_CONFIG_REGISTRY = 'https://registry.npmjs.org'
NPM_CONFIG_STORE = '/root/.local/share/pnpm/store'
PNPM_HOME = '/root/.local/share/pnpm'

[build.env]
PRISMA_SCHEMA_ENGINE_BINARY = '/root/.cache/prisma/master/schema-engine-debian-openssl-1.1.x'
PRISMA_QUERY_ENGINE_BINARY = '/root/.cache/prisma/master/libquery_engine-debian-openssl-1.1.x.so.node'
PRISMA_QUERY_ENGINE_LIBRARY = '/root/.cache/prisma/master/libquery_engine-debian-openssl-1.1.x.so.node'
PRISMA_ENGINE_PROTOCOL = 'graphql'
SKIP_PRISMA_POSTINSTALL = 'true'
